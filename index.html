
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>a4</title>
    <meta name="description" content="Assignment 4">
    <link id="favicon" rel="icon" href="https://glitch.com/edit/favicon-app.ico" type="image/x-icon">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./style.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">
    <script src="js/three.js"></script>
    <script src="js/physi.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script type="text/javascript" src="https://raw.githubusercontent.com/dataarts/dat.gui/master/build/dat.gui.js"></script>
  </head>
  <body>
     <script>
  
      'use strict';
      let count = 0
      let score = 0
      Physijs.scripts.worker = 'js/physijs_worker.js';
      Physijs.scripts.ammo = 'ammo.js';
      let initScene, render, renderer, scene, camera, box, ground, ground_material, friction, controls;
      var xPos = 0
      var yPos = 0
      initScene = function() {
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.getElementById( 'viewport' ).appendChild( renderer.domElement );

        scene = new Physijs.Scene;
        camera = new THREE.PerspectiveCamera(
          35,
          window.innerWidth / window.innerHeight,
          1,
          1000
        );
        camera.position.set( 300, 100, 60 );
        camera.lookAt( scene.position );
        scene.add( camera );
        
        var loader = new THREE.TextureLoader();
        loader.load('https://cdn.glitch.com/c3c1ab32-34b4-400c-9040-faa6873ac320%2F8bb0cedfaea9e07b8c3aa6f8c41684bc.jpg?v=1569202443143',
          function ( texture ) {
              ground_material = Physijs.createMaterial( new THREE.MeshBasicMaterial({map: texture}) ,.8, .9),
              ground = new Physijs.BoxMesh(new THREE.BoxGeometry(150, 30, 150),ground_material,1);
              ground.receiveShadow = true;
              ground.__dirtyRotation = true;
              var constraint = new Physijs.PointConstraint( ground, new THREE.Vector3( 0, 0, 0 ));
              scene.add( ground );
              scene.addConstraint( constraint );
          });
        
        let floor_mat = Physijs.createMaterial(new THREE.MeshBasicMaterial( { color: 0x0000FF } ) ,.9, .9), 
        floor = new Physijs.BoxMesh (new THREE.BoxGeometry(1000,1,1000), floor_mat, 0);
        floor.addEventListener( 'collision', function( objCollidedWith, linearVelOfCollision, angularVelOfCollision ) {
           document.getElementById('textend').innerHTML = score
           end()
        });
        floor.position.y = -30;

        
        let ball_material = Physijs.createMaterial(new THREE.MeshBasicMaterial( { color: 0xFFFFFF } ) ,.9, .9), 
        box = new Physijs.BoxMesh (new THREE.BoxGeometry(10,10,10), ball_material, 1);
        box.addEventListener( 'collision', function( objCollidedWith, linearVelOfCollision, angularVelOfCollision ) {
           score++
           document.getElementById('text').innerHTML = score
           on()
           setTimeout(function(){
                off();
            },500);
        });
        
        requestAnimationFrame( render );
        box.position.z = 10;
        box.position.x = 0;
        box.position.y = 50;
        box.rotation.x = 10;
        box.__dirtyPosition = true;

        function getCurrPos(event){
           let img = new Image();
           event.dataTransfer.setDragImage(img, 0, 0);
           xPos = event.clientX
           yPos = event.clientY
           ground.__dirtyRotation = true;
           ground.rotation.set(xPos/200, 0, yPos /100)
        }
        
        function on() {
          document.getElementById("overlay").style.display = "block";
        }

        function off() {
          document.getElementById("overlay").style.display = "none";
        }
        
         function end() {
          document.getElementById("overlayend").style.display = "block";
        }

        function start() {
          document.getElementById("overlaystart").style.display = "block";
        }
        function dismiss(){
          document.getElementById("overlaystart").style.display = "none";
        }
        
        function drag(event){
          let img = new Image();
          event.dataTransfer.setDragImage(img, 0, 0);
         // document.getElementById('title').innerHTML = "drag"
        }
        
        function reset(event){
           ground.__dirtyRotation = true;
           ground.rotation.set(0,0,0)
           ground.setAngularVelocity(new THREE.Vector3(0, 0, 0));
        }
       
      document.addEventListener("keydown", onDocumentKeyDown, false); 
      document.getElementById('viewport').ondrag = getCurrPos
      document.getElementById('viewport').ondragstart = drag
      document.getElementById('viewport').ondragend = reset
       
      render = function() {
        scene.simulate();
        renderer.render( scene, camera); // render the scen
        requestAnimationFrame( render );
      };   

      window.onload = function(){
        initScene();
        render();
        /*
        var gui = new dat.GUI()
        gui.add(box, 'message');
        gui.add(box, 'speed', -5, 5);
        gui.add(box, 'displayOutline');
        gui.add(box, 'explode');
        */
      }
    
    </script>
    
    <div id="overlay">
      <div id="text"></div>
    </div>
    <div id="overlayend">
      <div id="textend"></div>
    </div>
     <div id="overlaystart">
      <div id="textstart"></div>
    </div>
    <p id="title">
      BALANCE THE CUBE
    </p>
    	<div id="viewport" draggable = "true"></div>
  </body>
</html>
